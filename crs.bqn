#!/usr/bin/env bqn

# Modified version of https://github.com/mlochbaum/BQN/blob/master/src/cjs.bqn, which is under the ISC license (https://github.com/mlochbaum/BQN/blob/master/LICENSE)

argsâ†â€¢args
"Usage: ./crs.bqn path/to/mlochbaum/BQN <an expression>"!2â‰¤â‰ args
return â† 1â‰¡âŠ‘args
argsâ†“Ëœâ†© return
pathâ†(âŠ‘args)âˆ¾"/src/"
argsâ†“Ëœâ†©1
Import â† {ğ•¨â€¢Import pathâˆ¾ğ•©}
FChars â† {ğ•¨â€¢FChars pathâˆ¾ğ•©}
FLines â† {ğ•¨â€¢FLines pathâˆ¾ğ•©}

# Javascript/JSON formatting
List â† "vec!["âˆ¾"]"âˆ¾Ëœ(0<â‰ )â—¶âŸ¨"",1â†“Â·âˆ¾","âŠ¸âˆ¾Â¨âŸ© # Native list/array
Tuple â† "("âˆ¾")"âˆ¾Ëœ(0<â‰ )â—¶âŸ¨"",1â†“Â·âˆ¾","âŠ¸âˆ¾Â¨âŸ© # Native tuple
Block â† Tuple # Native block
Body â† Tuple # Native body
Code â† Tuple # Native code
Ind â† {âˆ¾ğ•¨â€¿"["â€¿ğ•©â€¿"]"}          # Native list/array indexing
Cat â† {âˆ¾ğ•¨â€¿".concat("â€¿ğ•©â€¿")"}   # Native list/array concatenation (like âˆ¾)
# Escape the special characters that appear in BQN sources.
Escâ†{
  in â† (@+0â€¿9â€¿10â€¿13)âˆ¾"'"""    # Null, Tab, LF, CR, and quotes
  out â† "0tnr"                # Whitespace characters changed to letters
  i â† inâŠğ•©
  ğ•© â†© i âŠâŸœoutâŒ¾((i<â‰ out)âŠ¸/) ğ•©  # Replace
  âˆ¾(i<â‰ in) /âŸœ"\"âŠ¸âˆ¾Â¨ ğ•©         # Insert \
}âŸ(0<â‰ )
Str â† "str("""âˆ¾Escâˆ¾""")"Ëœ     # A BQN string
Char â† "'"(âˆ¾âˆ¾âŠ£)Escâˆ˜â¥Š          # A BQN character
F â† â€¢Repr                     # Native format
FP â† âˆâŠ¸=â—¶âŸ¨F,"Infinity"âŸ©       # Format positive number
Num â† 0âŠ¸â‰¤â—¶âŸ¨")"âˆ¾Ëœ"new_scalar(-"âˆ¾(FPâˆ˜|),")"âˆ¾Ëœ"new_scalar("âˆ¾FPâŸ©       # Format number

glyphs â† Import "glyphs.bqn"
_getComp â† { (4+useInd) â†‘ (ğ•— Import "c.bqn"){ğ”½} }
useInd â† "-i"â‰¡âŠ‘args â‹„ argsâ†“Ëœâ†©useInd
Comp â† ((<"runtime" Ind F)Â¨â†•62) glyphs _getComp âŠ¢
J â† âˆ¾âˆ¾âŸœ(@+10)Â¨
Fconst â† â‰¡â—¶âŸ¨@âŠ¸â‰¤â—¶{Numğ•©}â€¿Char, Str, âŠ‘âŸ©
Fout â† (â‰ â†‘âŸ¨F,Fconst,Block=â—¶âŸ¨F,List(List FÂ¨)Â¨âŸ©Â¨,BodyÂ·FÂ¨2âŠ¸â†‘,List FâŸ©Ë™) {List ğ•Â¨ğ•©}Â¨ âŠ¢
Long â† âˆ¾ (â‰ â†‘1â€¿3/âŸ¨"  "âŠ¸âˆ¾â‹„((@+10)âˆ¾" ,")âŠ¸âˆ¾âŸ©Ë™) {ğ•ğ•©}Â¨ âŠ¢
LFC â† Longâˆ˜Foutâˆ˜Comp

RT â† {
  srcâ€¿needâ€¿inputsâ†ğ•©Import"pr.bqn"
  prâ†"runtime_0"â€¿"provide"{(âˆ¾ğ•¨<âŠ¸(<âˆ˜IndâŸœFÂ¨)âŸœ(â†•â‰ )Â¨ğ•©)âŠËœ(âˆ¾ğ•©)âŠâˆ¾need}â—‹((-1+1=ğ•©)âŠ¸â†‘)inputs
  Long Fout pr need _getComp src
}
CArg â† {Numâ†©Ï€âŠ¸=â—¶Numâ€¿"Math.PI" â‹„ J (Â¯5âŠ¸â†“âˆ¾ğ•©Ë™)âŒ¾âŠ‘ FLines "c.bqn"}
SVG â† {âˆ¾âŸ¨"Modifyâ†GetHighlightsâ†âŠ¢â‹„"âŸ©âˆ¾ FCharsâˆ˜âˆ¾âŸœ".bqn"Â¨ "../svg"â€¿ğ•©}

â€¢Out (âŠ‘"r"â€¿"r0"â€¿"r1"â€¿"c"â€¿"cc"â€¿"f"â€¿"e"â€¿"p"âŠâŠ)â—¶âŸ¨
  RTâˆ˜2, RTâˆ˜0, RTâˆ˜1
  {ğ•©â‹„LFC CArg "âŸ¨"âˆ¾"âŸ©"Â«âˆ¾","âŠ¸âˆ¾Â¨'"'(âŠ£âˆ¾âˆ¾Ëœ)Â¨glyphs}
  {ğ•©â‹„LFC "{"âˆ¾"}"âˆ¾ËœCArg"ğ•©"}
  {ğ•©â‹„LFC FChars "f.bqn"}
  {ğ•©â‹„LFC SVG "e"}
  {ğ•©â‹„LFC SVG "p"}
  Â¯1 â†“ Â· J Codeâˆ˜Foutâˆ˜CompÂ¨
âŸ© args
